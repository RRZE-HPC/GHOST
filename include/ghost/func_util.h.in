/**
 * @file func_util.h
 * @brief Utilities for functions.
 * @author Moritz Kreutzer <moritz.kreutzer@fau.de>
 */
#ifndef GHOST_FUNC_UTIL_H
#define GHOST_FUNC_UTIL_H

#include <ghost/task.h>
#include <ghost/core.h>

typedef enum
{
    GHOST_FUNCTYPE_MATH = 1,
    GHOST_FUNCTYPE_UTIL = 2,
    GHOST_FUNCTYPE_COMMUNICATION = 4,
    GHOST_FUNCTYPE_PREPROCESS = 8,
    GHOST_FUNCTYPE_INITIALIZATION = 16,
    GHOST_FUNCTYPE_KERNEL = 32
} ghost_functype_t;

#define GHOST_FUNC_ENTER(functype)\
    int __funcnameoffset;\
    bool __ghost_instr_enable_backup;\
    char * __prefixbackup = NULL;\
    char * __prefix = NULL;\
    char * __ghost_functag = NULL;\
    if (${INSTRUMENTATION_FUNCTYPES}) {\
        ghost_malloc((void**)&__prefix,1024*sizeof(char));\
        ghost_malloc((void**)&__ghost_functag,1024*sizeof(char));\
        __funcnameoffset = strncmp(__FUNCTION__,"ghost_",6)?0:6;\
        __ghost_instr_enable_backup = ghost_instr_enable;\
        __prefixbackup = ghost_instr_prefix_get();\
        snprintf(__ghost_functag,1024,"%s%s",__prefixbackup,\
                __FUNCTION__+__funcnameoffset);\
        snprintf(__prefix,1024,"%s%s->",__prefixbackup,\
            __FUNCTION__+__funcnameoffset);\
        ghost_instr_enable = true;\
        GHOST_INSTR_START(__FUNCTION__+__funcnameoffset);\
        ghost_instr_prefix_set(__prefix);\
    } else {\
        ghost_instr_enable = false;\
    }\
    if ((functype) == (GHOST_FUNCTYPE_MATH|GHOST_FUNCTYPE_KERNEL)) {\
        ghost_task_t *cur = NULL;\
        ghost_task_cur(&cur);\
        if (!cur) {\
            PERFWARNING_LOG("A mathematical kernel has been called outside a task!");\
        }else if(cur->nThreads == 0) {\
            PERFWARNING_LOG("A mathematical kernel has been called in a task with 0 threads!");\
        }\
    }\
    if (GHOST_VERBOSITY > 1) {\
        DEBUG_LOG(1,"Enter function %s",__FUNCTION__);\
    } 

#define GHOST_FUNC_EXIT(functype)\
    if (${INSTRUMENTATION_FUNCTYPES}) {\
        /*ghost_barrier();*/\
        ghost_instr_prefix_set(__prefixbackup);\
        GHOST_INSTR_STOP(__FUNCTION__+__funcnameoffset);\
        ghost_instr_enable = __ghost_instr_enable_backup;\
        free(__ghost_functag);\
        free(__prefix);\
    }\
    if (GHOST_VERBOSITY > 1) {\
        DEBUG_LOG(1,"Exit function %s",__FUNCTION__);\
    } 

#endif
